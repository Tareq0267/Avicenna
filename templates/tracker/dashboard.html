{% extends 'base.html' %}
{% load static %}

{% block content %}
<!-- Partner Mode Banner (when viewing partner's dashboard) -->
{% if viewing_partner %}
<div class="partner-banner">
  <div class="partner-banner-content">
    <div class="partner-banner-icon">
      <i class="bi bi-heart-fill"></i>
    </div>
    <div class="partner-banner-text">
      <span class="partner-banner-label">Peeking at</span>
      <span class="partner-banner-name">{{ partner_name }}'s Journey</span>
    </div>
    <a href="{% url 'tracker:dashboard' %}" class="btn btn-sm btn-light partner-banner-btn">
      <i class="bi bi-arrow-left me-1"></i>Back to Mine
    </a>
  </div>
</div>
{% endif %}

<!-- Partner Toggle Card (only show if user has a partner and viewing own dashboard) -->
{% if partner and not viewing_partner %}
<div class="partner-toggle-wrapper mb-3">
  <a href="{% url 'tracker:partner_dashboard' %}" class="partner-toggle-card">
    <div class="partner-toggle-icon">
      <i class="bi bi-heart-fill"></i>
    </div>
    <div class="partner-toggle-text">
      <span class="partner-toggle-label">Couples Mode</span>
      <span class="partner-toggle-name">Peek at {{ partner_name }}'s progress</span>
    </div>
    <div class="partner-toggle-arrow">
      <i class="bi bi-chevron-right"></i>
    </div>
  </a>
</div>
{% endif %}

<!-- Calorie Setup Prompt (show if profile not complete and not viewing partner) -->
{% if not calorie_profile_complete and not viewing_partner %}
<div class="calorie-setup-prompt mb-4">
  <div class="setup-prompt-content">
    <div class="setup-prompt-icon">
      <i class="bi bi-bullseye"></i>
    </div>
    <div class="setup-prompt-text">
      <strong>Set up your calorie goal</strong>
      <p class="mb-0 text-muted">Get personalized daily calorie targets based on your fitness goals</p>
    </div>
    <a href="{% url 'tracker:calorie_setup' %}" class="btn btn-primary">
      <i class="bi bi-gear me-1"></i>Set Up Now
    </a>
  </div>
</div>
{% endif %}

<!-- Calorie Goal Card (show if profile is complete) -->
{% if calorie_status %}
<div class="calorie-goal-card mb-4">
  <div class="row align-items-center">
    <div class="col-md-8">
      <div class="calorie-header">
        <div class="calorie-icon {% if calorie_status.fitness_goal == 'lose' %}lose{% elif calorie_status.fitness_goal == 'gain' %}gain{% else %}maintain{% endif %}">
          {% if calorie_status.fitness_goal == 'lose' %}
          <i class="bi bi-arrow-down-circle"></i>
          {% elif calorie_status.fitness_goal == 'gain' %}
          <i class="bi bi-arrow-up-circle"></i>
          {% else %}
          <i class="bi bi-arrow-left-right"></i>
          {% endif %}
        </div>
        <div class="calorie-title">
          {% if calorie_status.fitness_goal == 'lose' %}
          <h5 class="mb-0">Calories Left Today</h5>
          <small class="text-muted">Stay under your goal to lose weight</small>
          {% elif calorie_status.fitness_goal == 'gain' %}
          <h5 class="mb-0">Calories to Surpass</h5>
          <small class="text-muted">Exceed your goal to gain weight</small>
          {% else %}
          <h5 class="mb-0">Calorie Target</h5>
          <small class="text-muted">Stay close to maintain your weight</small>
          {% endif %}
        </div>
      </div>
      <div class="calorie-progress mt-3">
        <div class="progress" style="height: 12px; border-radius: 6px;">
          <div class="progress-bar {% if calorie_status.status == 'under' %}bg-success{% elif calorie_status.status == 'on_track' %}bg-warning{% else %}bg-danger{% endif %}"
               role="progressbar"
               style="width: {{ calorie_status.progress_percent }}%;"
               aria-valuenow="{{ calorie_status.calories_consumed }}"
               aria-valuemin="0"
               aria-valuemax="{{ calorie_status.daily_goal }}">
          </div>
        </div>
        <div class="d-flex justify-content-between mt-1">
          <small class="text-muted">{{ calorie_status.calories_consumed }} consumed</small>
          <small class="text-muted">{{ calorie_status.daily_goal }} goal</small>
        </div>
      </div>
    </div>
    <div class="col-md-4 text-center">
      <div class="calorie-remaining {% if calorie_status.status == 'under' %}text-success{% elif calorie_status.status == 'on_track' %}text-warning{% else %}text-danger{% endif %}">
        {% if calorie_status.calories_remaining >= 0 %}
        <span class="calorie-number">{{ calorie_status.calories_remaining }}</span>
        <span class="calorie-label">kcal {% if calorie_status.fitness_goal == 'gain' %}to go{% else %}left{% endif %}</span>
        {% else %}
        <span class="calorie-number">{{ calorie_status.calories_remaining|slice:"1:" }}</span>
        <span class="calorie-label">kcal {% if calorie_status.fitness_goal == 'gain' %}over - great!{% else %}over{% endif %}</span>
        {% endif %}
      </div>
      {% if not viewing_partner %}
      <button type="button" class="btn btn-sm btn-outline-secondary mt-2" data-bs-toggle="modal" data-bs-target="#calorieSettingsModal">
        <i class="bi bi-gear"></i> Settings
      </button>
      {% endif %}
    </div>
  </div>
</div>
{% endif %}

<!-- Activity Heatmap -->
<div class="row mb-4">
  <div class="col-12">
    <div class="chart-card">
      <h6 class="chart-title mb-2"><i class="bi bi-calendar3 me-2"></i>Activity Heatmap</h6>
      <div class="heatmap-wrapper d-flex align-items-center">
        <button type="button" class="btn btn-sm btn-outline-secondary heatmap-nav-btn" id="heatmapPrev" title="Previous months">
          <i class="bi bi-chevron-left"></i>
        </button>
        <div id="heatmapChart" class="heatmap-container flex-grow-1"></div>
        <button type="button" class="btn btn-sm btn-outline-secondary heatmap-nav-btn" id="heatmapNext" title="Next months">
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
      <div class="text-center mt-2">
        <span class="text-muted small" id="heatmapRange"></span>
      </div>
    </div>
  </div>
</div>

<!-- Summary Cards -->
<div class="row g-3 mb-4">
  <div class="col-6 col-md-4">
    <div class="stat-card">
      <div class="stat-icon cal-icon"><i class="bi bi-fire"></i></div>
      <div class="stat-info">
        <span class="stat-label">Calories (7d)</span>
        <span class="stat-value">{{ total_calories|default:0 }} <small>kcal</small></span>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-4">
    <div class="stat-card">
      <div class="stat-icon ex-icon"><i class="bi bi-lightning-charge"></i></div>
      <div class="stat-info">
        <span class="stat-label">Exercise (7d)</span>
        <span class="stat-value">{{ total_exercise_min|default:0 }} <small>min</small></span>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-4">
    <div class="stat-card">
      <div class="stat-icon wt-icon"><i class="bi bi-speedometer2"></i></div>
      <div class="stat-info">
        <span class="stat-label">Latest Weight</span>
        <span class="stat-value">{% if latest_weight %}{{ latest_weight }} <small>kg</small>{% else %}â€”{% endif %}</span>
      </div>
    </div>
  </div>
</div>

<!-- Charts Row -->
<div class="row g-3 mb-4">
  <div class="col-12 col-lg-6">
    <div class="chart-card">
      <h6 class="chart-title">Daily Calories</h6>
      <div id="calChart" class="chart-container position-relative">
        <div id="calChartEmpty" class="chart-empty-state d-none">
          <i class="bi bi-fire"></i>
          <p>No calorie data yet</p>
        </div>
      </div>
    </div>
  </div>
  <div class="col-12 col-lg-6">
    <div class="chart-card">
      <h6 class="chart-title">Exercise Minutes</h6>
      <div id="exChart" class="chart-container position-relative">
        <div id="exChartEmpty" class="chart-empty-state d-none">
          <i class="bi bi-lightning-charge"></i>
          <p>No exercise data yet</p>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-3 mb-4">
  <div class="col-12 col-lg-6">
    <div class="chart-card">
      <h6 class="chart-title">Weight Trend</h6>
      <div id="wtChart" class="chart-container position-relative">
        <div id="wtChartEmpty" class="chart-empty-state d-none">
          <i class="bi bi-speedometer2"></i>
          <p>No weight data yet</p>
        </div>
      </div>
    </div>
  </div>
  <div class="col-12 col-lg-6">
    <div class="chart-card">
      <h6 class="chart-title">Recent Entries</h6>
      <ul class="nav nav-tabs" id="entryTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="diet-tab" data-bs-toggle="tab" data-bs-target="#diet" type="button">Diet</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="ex-tab" data-bs-toggle="tab" data-bs-target="#exercise" type="button">Exercise</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="wt-tab" data-bs-toggle="tab" data-bs-target="#weight" type="button">Weight</button>
        </li>
      </ul>
      <div class="tab-content pt-3" id="entryTabsContent">
        <div class="tab-pane fade show active" id="diet" role="tabpanel">
          <div class="table-responsive" style="max-height: 220px; overflow-y: auto;">
          <table class="table table-sm align-middle">
            <thead><tr><th>Date</th><th>Item</th><th>Calories</th><th></th></tr></thead>
            <tbody>
            {% for e in dietary_recent %}
              <tr>
                <td>{{ e.date }}</td>
                <td>{{ e.item|default:"-" }}{% if e.notes %} <small class="text-muted">({{ e.notes }})</small>{% endif %}</td>
                <td>{{ e.calories }}</td>
                <td>
                  <form method="post" action="{% url 'tracker:delete_dietary_entry' e.id %}" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-danger" title="Delete" onclick="return confirm('Delete this entry?');">
                      <i class="bi bi-trash"></i>
                    </button>
                  </form>
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="4" class="text-muted">No entries</td></tr>
            {% endfor %}
            </tbody>
          </table>
          </div>
        </div>
        <div class="tab-pane fade" id="exercise" role="tabpanel">
          <div class="table-responsive" style="max-height: 220px; overflow-y: auto;">
          <table class="table table-sm align-middle">
            <thead><tr><th>Date</th><th>Activity</th><th>Duration</th><th>Burned</th><th></th></tr></thead>
            <tbody>
            {% for e in exercise_recent %}
              <tr>
                <td>{{ e.date }}</td>
                <td>{{ e.activity }}</td>
                <td>{{ e.duration_minutes }} min</td>
                <td>{{ e.calories_burned|default:"-" }} kcal</td>
                <td>
                  <form method="post" action="{% url 'tracker:delete_exercise_entry' e.id %}" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-danger" title="Delete" onclick="return confirm('Delete this entry?');">
                      <i class="bi bi-trash"></i>
                    </button>
                  </form>
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="5" class="text-muted">No entries</td></tr>
            {% endfor %}
            </tbody>
          </table>
          </div>
        </div>
        <div class="tab-pane fade" id="weight" role="tabpanel">
          <table class="table table-sm align-middle">
            <thead><tr><th>Date</th><th>Weight (kg)</th><th></th></tr></thead>
            <tbody>
            {% for e in weight_recent %}
              <tr>
                <td>{{ e.date }}</td>
                <td>{{ e.weight_kg }}</td>
                <td>
                  <form method="post" action="{% url 'tracker:delete_weight_entry' e.id %}" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-danger" title="Delete" onclick="return confirm('Delete this entry?');">
                      <i class="bi bi-trash"></i>
                    </button>
                  </form>
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="3" class="text-muted">No entries</td></tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Daily Recap Modal -->
<div class="modal fade" id="dailyRecapModal" tabindex="-1" aria-labelledby="dailyRecapModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="dailyRecapModalLabel"><i class="bi bi-calendar-day me-2"></i>Daily Recap - <span id="recapDate"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="recapLoading" class="text-center py-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
        <div id="recapContent" class="d-none">
          <!-- Summary Cards -->
          <div class="row g-3 mb-4">
            <div class="col-6 col-md-3">
              <div class="card bg-light text-center p-2">
                <div class="text-muted small">Calories In</div>
                <div class="fw-bold text-primary" id="recapCalIn">0</div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="card bg-light text-center p-2">
                <div class="text-muted small">Burned</div>
                <div class="fw-bold text-success" id="recapCalBurned">0</div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="card bg-light text-center p-2">
                <div class="text-muted small">Net</div>
                <div class="fw-bold" id="recapNetCal">0</div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="card bg-light text-center p-2">
                <div class="text-muted small">Exercise</div>
                <div class="fw-bold text-info" id="recapExMin">0 min</div>
              </div>
            </div>
          </div>
          
          <!-- Food Section -->
          <h6 class="border-bottom pb-2 mb-3"><i class="bi bi-egg-fried me-2"></i>Food</h6>
          <div id="recapFoodList" class="mb-4"></div>
          
          <!-- Exercise Section -->
          <h6 class="border-bottom pb-2 mb-3"><i class="bi bi-lightning-charge me-2"></i>Exercise</h6>
          <div id="recapExerciseList" class="mb-4"></div>
          
          <!-- Weight Section -->
          <div id="recapWeightSection">
            <h6 class="border-bottom pb-2 mb-3"><i class="bi bi-speedometer2 me-2"></i>Weight</h6>
            <div id="recapWeightList"></div>
          </div>

          <!-- Coach Feedback / Remarks Section -->
          <div id="recapRemarksSection" class="mb-4">
            <h6 class="border-bottom pb-2 mb-3"><i class="bi bi-person-heart me-2"></i>Coach Feedback</h6>
            <div id="recapRemarksContent" class="d-none"></div>
            <div id="recapRemarksEmpty" class="text-muted">No coach feedback for this day.</div>
          </div>
        </div>

        <div id="recapEmpty" class="d-none text-center py-4 text-muted">
          <i class="bi bi-inbox fs-1 d-block mb-2"></i>
          No entries for this day.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Calorie Settings Modal -->
{% if calorie_status and not viewing_partner %}
<div class="modal fade" id="calorieSettingsModal" tabindex="-1" aria-labelledby="calorieSettingsModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="calorieSettingsModalLabel"><i class="bi bi-gear me-2"></i>Calorie Settings</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="calorieSettingsForm" method="post" action="{% url 'tracker:update_calorie_settings' %}">
        {% csrf_token %}
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Goal</label>
            <select name="fitness_goal" class="form-select">
              <option value="lose" {% if calorie_status.fitness_goal == 'lose' %}selected{% endif %}>Lose Weight</option>
              <option value="maintain" {% if calorie_status.fitness_goal == 'maintain' %}selected{% endif %}>Maintain Weight</option>
              <option value="gain" {% if calorie_status.fitness_goal == 'gain' %}selected{% endif %}>Gain Weight</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Activity Level</label>
            <select name="activity_level" class="form-select">
              <option value="sedentary">Sedentary (little or no exercise)</option>
              <option value="light">Lightly Active (1-3 days/week)</option>
              <option value="moderate">Moderately Active (3-5 days/week)</option>
              <option value="active">Very Active (6-7 days/week)</option>
              <option value="extra">Extra Active (very active + physical job)</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Age</label>
            <input type="number" name="age" class="form-control" min="10" max="120">
          </div>
          <div class="alert alert-info py-2">
            <small><i class="bi bi-info-circle me-1"></i>Your calorie goal will be recalculated based on your latest weight entry.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

<style>
/* Calorie Setup Prompt */
.calorie-setup-prompt {
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(129, 140, 248, 0.05));
  border: 1px solid rgba(99, 102, 241, 0.2);
  border-radius: 1rem;
  padding: 1.25rem;
}

.setup-prompt-content {
  display: flex;
  align-items: center;
  gap: 1rem;
  flex-wrap: wrap;
}

.setup-prompt-icon {
  width: 48px;
  height: 48px;
  border-radius: 0.75rem;
  background: linear-gradient(135deg, #6366f1, #818cf8);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  color: #fff;
}

.setup-prompt-text {
  flex: 1;
  min-width: 200px;
}

.setup-prompt-text strong {
  font-size: 1.1rem;
  color: var(--text, #1f2937);
}

/* Calorie Goal Card */
.calorie-goal-card {
  background: var(--card-bg, #fff);
  border: 1px solid var(--border, #e9ecef);
  border-radius: 1rem;
  padding: 1.5rem;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
}

.calorie-header {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.calorie-icon {
  width: 48px;
  height: 48px;
  border-radius: 0.75rem;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
}

.calorie-icon.lose {
  background: #fef2f2;
  color: #ef4444;
}

.calorie-icon.gain {
  background: #eff6ff;
  color: #3b82f6;
}

.calorie-icon.maintain {
  background: #f0fdf4;
  color: #22c55e;
}

.calorie-remaining {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.calorie-number {
  font-size: 2.5rem;
  font-weight: 700;
  line-height: 1;
}

.calorie-label {
  font-size: 0.9rem;
  opacity: 0.8;
}

/* Progress bar styling */
.calorie-progress .progress {
  background: #e9ecef;
}

/* Coach Recap Card */
.coach-recap-card {
  display: flex;
  gap: 1rem;
  padding: 1rem;
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(52, 211, 153, 0.05));
  border: 1px solid rgba(16, 185, 129, 0.2);
  border-radius: 0.75rem;
}

.coach-recap-avatar {
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, #10b981, #34d399);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.25rem;
  color: #fff;
  flex-shrink: 0;
}

.coach-recap-message {
  color: var(--text, #1f2937);
  font-size: 0.95rem;
  line-height: 1.5;
}

@media (max-width: 768px) {
  .calorie-goal-card .col-md-4 {
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 1px solid #e9ecef;
  }

  .setup-prompt-content {
    flex-direction: column;
    text-align: center;
  }

  .setup-prompt-content .btn {
    width: 100%;
  }
}
</style>

<!-- ECharts -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const calDates = {{ cal_dates|safe }};
  const calValues = {{ cal_values|safe }};
  const exDates = {{ ex_dates|safe }};
  const exValues = {{ ex_values|safe }};
  const wtDates = {{ wt_dates|safe }};
  const wtValues = {{ wt_values|safe }};
  const heatmapData = {{ heatmap_data|safe }};
  const heatmapStart = '{{ heatmap_start }}';
  const heatmapEnd = '{{ heatmap_end }}';
  const todayStr = '{{ today }}';
  const viewingPartner = {{ viewing_partner|yesno:"true,false" }};
  const targetUserId = {{ target_user.id }};
  const dailyCalorieGoal = {% if calorie_status %}{{ calorie_status.daily_goal }}{% else %}null{% endif %};

  const tooltipStyle = { trigger: 'axis', backgroundColor: '#fff', borderColor: '#e5e5e5', textStyle: { color: '#333' } };
  const gridStyle = { left: '3%', right: '4%', bottom: '3%', containLabel: true };

  // Detect mobile
  const isMobile = window.innerWidth < 576;

  // ---------- Activity Heatmap with Month Navigation ----------
  const heatmapChart = echarts.init(document.getElementById('heatmapChart'));

  // Build activity count map
  const activityMap = {};
  heatmapData.forEach(function(item) { activityMap[item[0]] = item[1]; });

  // Heatmap navigation state
  let heatmapOffset = 0; // 0 = current period, negative = past months
  const monthsToShow = isMobile ? 1 : 6;
  
  function getMonthName(date) {
    return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
  }
  
  function updateHeatmapRange() {
    const today = new Date(todayStr);

    // Calculate start date based on offset
    const startMonth = new Date(today.getFullYear(), today.getMonth() + heatmapOffset, 1);
    const endMonth = new Date(startMonth.getFullYear(), startMonth.getMonth() + monthsToShow - 1, 1);
    const endDate = new Date(endMonth.getFullYear(), endMonth.getMonth() + 1, 0); // Last day of end month

    // Build date strings without timezone conversion
    const rangeStartStr = `${startMonth.getFullYear()}-${String(startMonth.getMonth() + 1).padStart(2, '0')}-01`;
    const rangeEndStr = `${endDate.getFullYear()}-${String(endDate.getMonth() + 1).padStart(2, '0')}-${String(endDate.getDate()).padStart(2, '0')}`;
    
    // Update range label
    const rangeLabel = document.getElementById('heatmapRange');
    if (isMobile) {
      rangeLabel.textContent = getMonthName(startMonth);
    } else {
      rangeLabel.textContent = getMonthName(startMonth) + ' - ' + getMonthName(endMonth);
    }

    // Generate data for this range - explicitly create entry for each day in month
    const rangeData = [];
    const targetYear = startMonth.getFullYear();
    const targetMonth = startMonth.getMonth();

    // Loop through each day of the target month(s)
    for (let m = 0; m < monthsToShow; m++) {
      // Use Date object to handle month/year rollovers correctly
      const monthDate = new Date(targetYear, targetMonth + m, 1);
      const year = monthDate.getFullYear();
      const month = monthDate.getMonth();
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      for (let day = 1; day <= daysInMonth; day++) {
        // Build date string directly to avoid timezone conversion issues
        const yearStr = String(year);
        const monthStr = String(month + 1).padStart(2, '0');
        const dayStr = String(day).padStart(2, '0');
        const dateStr = `${yearStr}-${monthStr}-${dayStr}`;

        const count = activityMap[dateStr] || 0;
        rangeData.push([dateStr, count]);
      }
    }
    
    // Check if today is in this range for highlighting
    const todayInRange = todayStr >= rangeStartStr && todayStr <= rangeEndStr;
    
    // Update chart
    heatmapChart.setOption({
      tooltip: {
        trigger: 'item',
        formatter: function(p) {
          if (!p.value) return '';
          const date = p.value[0];
          const count = p.value[1];
          const isToday = date === todayStr ? ' (Today)' : '';
          return date + isToday + '<br>Activities: ' + count;
        }
      },
      visualMap: {
        show: !isMobile,
        min: 0,
        max: 5,
        calculable: false,
        orient: 'horizontal',
        right: 30,
        bottom: 5,
        itemWidth: 12,
        itemHeight: 12,
        inRange: { color: ['#f5f5f5', '#9be9a8', '#40c463', '#30a14e', '#216e39'] },
        text: ['More', 'Less'],
        textStyle: { color: '#666', fontSize: 10 }
      },
      calendar: {
        top: isMobile ? 15 : 25,
        bottom: isMobile ? 5 : 30,
        left: isMobile ? 25 : 40,
        right: isMobile ? 5 : 20,
        cellSize: isMobile ? ['auto', 18] : 'auto',
        range: [rangeStartStr, rangeEndStr],
        itemStyle: { borderWidth: 2, borderColor: '#fff', borderRadius: 2 },
        splitLine: { show: false },
        yearLabel: { show: false },
        monthLabel: { show: !isMobile, nameMap: 'en', color: '#666', fontSize: 10 },
        dayLabel: { firstDay: 0, nameMap: ['S','M','T','W','T','F','S'], color: '#999', fontSize: isMobile ? 8 : 9 }
      },
      series: [
        {
          type: 'heatmap',
          coordinateSystem: 'calendar',
          data: rangeData
        },
        // Today highlight (only if in range)
        {
          type: 'scatter',
          coordinateSystem: 'calendar',
          symbolSize: isMobile ? 16 : 12,
          symbol: 'roundRect',
          data: todayInRange ? [[todayStr, activityMap[todayStr] || 0]] : [],
          itemStyle: {
            color: 'transparent',
            borderColor: '#fbbf24',
            borderWidth: 2
          },
          zlevel: 1
        }
      ]
    });
    
    // Update button states (disable Next if at current month)
    document.getElementById('heatmapNext').disabled = heatmapOffset >= 0;
  }
  
  // Navigation button handlers
  document.getElementById('heatmapPrev').addEventListener('click', function() {
    heatmapOffset -= monthsToShow;
    updateHeatmapRange();
  });
  
  document.getElementById('heatmapNext').addEventListener('click', function() {
    if (heatmapOffset < 0) {
      heatmapOffset += monthsToShow;
      if (heatmapOffset > 0) heatmapOffset = 0;
      updateHeatmapRange();
    }
  });
  
  // Initialize heatmap
  updateHeatmapRange();

  // Heatmap click handler - show daily recap
  heatmapChart.on('click', function(params) {
    // Hide tooltip immediately on click (fixes sticky hover on mobile)
    heatmapChart.dispatchAction({ type: 'hideTip' });
    
    if (params.value && params.value[0]) {
      showDailyRecap(params.value[0]);
    }
  });

  // Hide tooltip when touching outside on mobile
  if (isMobile) {
    document.addEventListener('touchstart', function(e) {
      if (!document.getElementById('heatmapChart').contains(e.target)) {
        heatmapChart.dispatchAction({ type: 'hideTip' });
      }
    });
  }

  // Calories line chart
  const calChart = echarts.init(document.getElementById('calChart'));
  if (calValues.length === 0 || calValues.every(v => v === 0)) {
    document.getElementById('calChartEmpty').classList.remove('d-none');
  } else {
    const calSeriesConfig = {
      data: calValues,
      type: 'line',
      smooth: true,
      lineStyle: { width: 3, color: '#6366f1' },
      areaStyle: { color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{ offset: 0, color: 'rgba(99,102,241,0.35)' }, { offset: 1, color: 'rgba(99,102,241,0.05)' }]) },
      symbol: 'circle',
      symbolSize: 8,
      itemStyle: { color: '#6366f1' }
    };
    // Add calorie goal line if available
    if (dailyCalorieGoal) {
      calSeriesConfig.markLine = {
        silent: true,
        symbol: 'none',
        lineStyle: { color: '#ef4444', width: 2, type: 'dashed' },
        label: { formatter: 'Goal: {c} kcal', position: 'insideEndTop', color: '#ef4444', fontSize: 11 },
        data: [{ yAxis: dailyCalorieGoal }]
      };
    }
    calChart.setOption({
      tooltip: tooltipStyle,
      grid: { left: '3%', right: '4%', bottom: '15%', containLabel: true },
      xAxis: { type: 'category', data: calDates, axisLine: { lineStyle: { color: '#ddd' } }, axisLabel: { color: '#666' } },
      yAxis: { type: 'value', splitLine: { lineStyle: { color: '#f0f0f0' } }, axisLabel: { color: '#666' } },
      dataZoom: [{ type: 'slider', start: calDates.length > 7 ? 100 - (7 / calDates.length * 100) : 0, end: 100, height: 20, bottom: 5, borderColor: '#e9ecef', fillerColor: 'rgba(99,102,241,0.1)', handleStyle: { color: '#6366f1' } }],
      series: [calSeriesConfig]
    });
  }

  // Exercise bar chart
  const exChart = echarts.init(document.getElementById('exChart'));
  if (exValues.length === 0 || exValues.every(v => v === 0)) {
    document.getElementById('exChartEmpty').classList.remove('d-none');
  } else {
    exChart.setOption({
      tooltip: tooltipStyle,
      grid: { left: '3%', right: '4%', bottom: '15%', containLabel: true },
      xAxis: { type: 'category', data: exDates, axisLine: { lineStyle: { color: '#ddd' } }, axisLabel: { color: '#666' } },
      yAxis: { type: 'value', splitLine: { lineStyle: { color: '#f0f0f0' } }, axisLabel: { color: '#666' } },
      dataZoom: [{ type: 'slider', start: exDates.length > 7 ? 100 - (7 / exDates.length * 100) : 0, end: 100, height: 20, bottom: 5, borderColor: '#e9ecef', fillerColor: 'rgba(16,185,129,0.1)', handleStyle: { color: '#10b981' } }],
      series: [{ data: exValues, type: 'bar', barWidth: '50%', itemStyle: { color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{ offset: 0, color: '#34d399' }, { offset: 1, color: '#10b981' }]), borderRadius: [6, 6, 0, 0] } }]
    });
  }

  // Weight line chart
  const wtChart = echarts.init(document.getElementById('wtChart'));
  if (wtValues.length === 0) {
    document.getElementById('wtChartEmpty').classList.remove('d-none');
  } else {
    wtChart.setOption({
      tooltip: tooltipStyle,
      grid: { left: '3%', right: '4%', bottom: '15%', containLabel: true },
      xAxis: { type: 'category', data: wtDates, axisLine: { lineStyle: { color: '#ddd' } }, axisLabel: { color: '#666' } },
      yAxis: { type: 'value', splitLine: { lineStyle: { color: '#f0f0f0' } }, axisLabel: { color: '#666' }, scale: true },
      dataZoom: [{ type: 'slider', start: wtDates.length > 7 ? 100 - (7 / wtDates.length * 100) : 0, end: 100, height: 20, bottom: 5, borderColor: '#e9ecef', fillerColor: 'rgba(245,158,11,0.1)', handleStyle: { color: '#f59e0b' } }],
      series: [{ data: wtValues, type: 'line', smooth: true, lineStyle: { width: 3, color: '#f59e0b' }, areaStyle: { color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{ offset: 0, color: 'rgba(245,158,11,0.35)' }, { offset: 1, color: 'rgba(245,158,11,0.05)' }]) }, symbol: 'circle', symbolSize: 8, itemStyle: { color: '#f59e0b' } }]
    });
  }

  window.addEventListener('resize', function() { heatmapChart.resize(); calChart.resize(); exChart.resize(); wtChart.resize(); });

  // ---------- Calorie Settings Form ----------
  const calorieSettingsForm = document.getElementById('calorieSettingsForm');
  if (calorieSettingsForm) {
    calorieSettingsForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(calorieSettingsForm);
      const submitBtn = calorieSettingsForm.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Saving...';

      fetch(calorieSettingsForm.action, {
        method: 'POST',
        body: formData,
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Reload page to show updated calorie goal
          window.location.reload();
        } else {
          alert(data.error || 'Failed to update settings');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Save Changes';
        }
      })
      .catch(error => {
        alert('Network error. Please try again.');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Save Changes';
      });
    });
  }

  // ---------- Daily Recap Modal ----------
  function showDailyRecap(dateStr) {
    const modal = new bootstrap.Modal(document.getElementById('dailyRecapModal'));
    const recapDate = document.getElementById('recapDate');
    const recapLoading = document.getElementById('recapLoading');
    const recapContent = document.getElementById('recapContent');
    const recapEmpty = document.getElementById('recapEmpty');
    
    // Format date nicely
    const dateObj = new Date(dateStr);
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    recapDate.textContent = dateObj.toLocaleDateString('en-US', options);
    
    // Show loading, hide content
    recapLoading.classList.remove('d-none');
    recapContent.classList.add('d-none');
    recapEmpty.classList.add('d-none');
    
    modal.show();

    // Fetch daily data (include user ID if viewing partner's data)
    let recapUrl = '/tracker/daily-recap/' + dateStr + '/';
    if (viewingPartner) {
      recapUrl = '/tracker/daily-recap/' + dateStr + '/user/' + targetUserId + '/';
    }
    fetch(recapUrl)
      .then(response => response.json())
      .then(data => {
        recapLoading.classList.add('d-none');
        
        if (!data.success) {
          recapEmpty.textContent = 'Error: ' + data.error;
          recapEmpty.classList.remove('d-none');
          return;
        }
        
        const hasData = data.dietary.length > 0 || data.exercise.length > 0 || data.weight.length > 0;
        
        if (!hasData) {
          recapEmpty.classList.remove('d-none');
          return;
        }
        
        // Populate summary
        document.getElementById('recapCalIn').textContent = data.summary.total_calories_in + ' kcal';
        document.getElementById('recapCalBurned').textContent = data.summary.total_calories_burned + ' kcal';
        document.getElementById('recapExMin').textContent = data.summary.total_exercise_min + ' min';
        
        const netCal = document.getElementById('recapNetCal');
        netCal.textContent = data.summary.net_calories + ' kcal';
        netCal.className = 'fw-bold ' + (data.summary.net_calories > 2000 ? 'text-danger' : 'text-success');
        
        // Populate food list
        const foodList = document.getElementById('recapFoodList');
        if (data.dietary.length > 0) {
          foodList.innerHTML = data.dietary.map(item => `
            <div class="d-flex justify-content-between align-items-start mb-2 p-2 bg-light rounded">
              <div>
                <strong>${item.item || 'Food item'}</strong>
                ${item.notes ? '<br><small class="text-muted">' + item.notes + '</small>' : ''}
                {% comment %} ${item.remarks ? '<br><small class="text-info"><i class="bi bi-chat-quote me-1"></i>' + item.remarks + '</small>' : ''} {% endcomment %}
              </div>
              <span class="badge bg-primary">${item.calories || 0} kcal</span>
            </div>
          `).join('');
        } else {
          foodList.innerHTML = '<p class="text-muted">No food entries</p>';
        }
        
        // Populate exercise list
        const exerciseList = document.getElementById('recapExerciseList');
        if (data.exercise.length > 0) {
          exerciseList.innerHTML = data.exercise.map(item => `
            <div class="d-flex justify-content-between align-items-start mb-2 p-2 bg-light rounded">
              <div>
                <strong>${item.activity || 'Exercise'}</strong>
                <br><small class="text-muted">${item.duration_minutes || 0} minutes</small>
                 {% comment %} ${item.remarks ? '<br><small class="text-info"><i class="bi bi-chat-quote me-1"></i>' + item.remarks + '</small>' : ''} {% endcomment %}
              </div>
              <span class="badge bg-success">-${item.calories_burned || 0} kcal</span>
            </div>
          `).join('');
        } else {
          exerciseList.innerHTML = '<p class="text-muted">No exercise entries</p>';
        }
        
        // Populate weight list
        const weightSection = document.getElementById('recapWeightSection');
        const weightList = document.getElementById('recapWeightList');
        if (data.weight.length > 0) {
          weightSection.classList.remove('d-none');
          weightList.innerHTML = data.weight.map(item => `
            <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
              <span><i class="bi bi-speedometer2 me-2"></i>${item.weight_kg} kg</span>
              ${item.notes ? '<small class="text-muted">' + item.notes + '</small>' : ''}
            </div>
          `).join('');
        } else {
          weightSection.classList.add('d-none');
        }
        
        // Coach Feedback / Remarks Section
        const remarksContent = document.getElementById('recapRemarksContent');
        const remarksEmpty = document.getElementById('recapRemarksEmpty');
        const allRemarks = data.all_remarks || [];

        // Clear previous content
        remarksContent.innerHTML = '';

        if (allRemarks.length > 0) {
          // Build coach cards for each remark
          allRemarks.forEach(remark => {
            const card = document.createElement('div');
            card.className = 'coach-recap-card mb-2';
            card.innerHTML = `
              <div class="coach-recap-avatar"><i class="bi bi-person-heart"></i></div>
              <div class="coach-recap-message">${remark}</div>
            `;
            remarksContent.appendChild(card);
          });
          remarksContent.classList.remove('d-none');
          remarksEmpty.classList.add('d-none');
        } else {
          remarksContent.classList.add('d-none');
          remarksEmpty.classList.remove('d-none');
        }
        recapContent.classList.remove('d-none');
      })
      .catch(err => {
        recapLoading.classList.add('d-none');
        recapEmpty.innerHTML = '<i class="bi bi-exclamation-triangle fs-1 d-block mb-2"></i>Failed to load data.';
        recapEmpty.classList.remove('d-none');
      });
  }
});
</script>
{% endblock %}

{% extends 'base.html' %}
{% load static %}

{% block content %}
<!-- Activity Heatmap -->
<div class="row mb-4">
  <div class="col-12">
    <div class="chart-card">
      <h6 class="chart-title mb-2"><i class="bi bi-calendar3 me-2"></i>Activity Heatmap</h6>
      <div id="heatmapChart" class="heatmap-container"></div>
    </div>
  </div>
</div>

<!-- Summary Cards -->
<div class="row g-3 mb-4">
  <div class="col-6 col-md-4">
    <div class="stat-card">
      <div class="stat-icon cal-icon"><i class="bi bi-fire"></i></div>
      <div class="stat-info">
        <span class="stat-label">Calories (7d)</span>
        <span class="stat-value">{{ total_calories|default:0 }} <small>kcal</small></span>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-4">
    <div class="stat-card">
      <div class="stat-icon ex-icon"><i class="bi bi-lightning-charge"></i></div>
      <div class="stat-info">
        <span class="stat-label">Exercise (7d)</span>
        <span class="stat-value">{{ total_exercise_min|default:0 }} <small>min</small></span>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-4">
    <div class="stat-card">
      <div class="stat-icon wt-icon"><i class="bi bi-speedometer2"></i></div>
      <div class="stat-info">
        <span class="stat-label">Latest Weight</span>
        <span class="stat-value">{% if latest_weight %}{{ latest_weight }} <small>kg</small>{% else %}â€”{% endif %}</span>
      </div>
    </div>
  </div>
</div>

<!-- Charts Row -->
<div class="row g-3 mb-4">
  <div class="col-12 col-lg-6">
    <div class="chart-card">
      <h6 class="chart-title">Daily Calories</h6>
      <div id="calChart" class="chart-container position-relative">
        <div id="calChartEmpty" class="chart-empty-state d-none">
          <i class="bi bi-fire"></i>
          <p>No calorie data yet</p>
        </div>
      </div>
    </div>
  </div>
  <div class="col-12 col-lg-6">
    <div class="chart-card">
      <h6 class="chart-title">Exercise Minutes</h6>
      <div id="exChart" class="chart-container position-relative">
        <div id="exChartEmpty" class="chart-empty-state d-none">
          <i class="bi bi-lightning-charge"></i>
          <p>No exercise data yet</p>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-3 mb-4">
  <div class="col-12 col-lg-6">
    <div class="chart-card">
      <h6 class="chart-title">Weight Trend</h6>
      <div id="wtChart" class="chart-container position-relative">
        <div id="wtChartEmpty" class="chart-empty-state d-none">
          <i class="bi bi-speedometer2"></i>
          <p>No weight data yet</p>
        </div>
      </div>
    </div>
  </div>
  <div class="col-12 col-lg-6">
    <div class="chart-card">
      <h6 class="chart-title">Recent Entries</h6>
      <ul class="nav nav-tabs" id="entryTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="diet-tab" data-bs-toggle="tab" data-bs-target="#diet" type="button">Diet</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="ex-tab" data-bs-toggle="tab" data-bs-target="#exercise" type="button">Exercise</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="wt-tab" data-bs-toggle="tab" data-bs-target="#weight" type="button">Weight</button>
        </li>
      </ul>
      <div class="tab-content pt-3" id="entryTabsContent">
        <div class="tab-pane fade show active" id="diet" role="tabpanel">
          <div class="table-responsive" style="max-height: 220px; overflow-y: auto;">
          <table class="table table-sm align-middle">
            <thead><tr><th>Date</th><th>Item</th><th>Calories</th></tr></thead>
            <tbody>
            {% for e in dietary_recent %}
              <tr>
                <td>{{ e.date }}</td>
                <td>{{ e.item|default:"-" }}{% if e.notes %} <small class="text-muted">({{ e.notes }})</small>{% endif %}</td>
                <td>{{ e.calories }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="3" class="text-muted">No entries</td></tr>
            {% endfor %}
            </tbody>
          </table>
          </div>
        </div>
        <div class="tab-pane fade" id="exercise" role="tabpanel">
          <div class="table-responsive" style="max-height: 220px; overflow-y: auto;">
          <table class="table table-sm align-middle">
            <thead><tr><th>Date</th><th>Activity</th><th>Duration</th><th>Burned</th></tr></thead>
            <tbody>
            {% for e in exercise_recent %}
              <tr>
                <td>{{ e.date }}</td>
                <td>{{ e.activity }}</td>
                <td>{{ e.duration_minutes }} min</td>
                <td>{{ e.calories_burned|default:"-" }} kcal</td>
              </tr>
            {% empty %}
              <tr><td colspan="4" class="text-muted">No entries</td></tr>
            {% endfor %}
            </tbody>
          </table>
          </div>
        </div>
        <div class="tab-pane fade" id="weight" role="tabpanel">
          <table class="table table-sm align-middle">
            <thead><tr><th>Date</th><th>Weight (kg)</th></tr></thead>
            <tbody>
            {% for e in weight_recent %}
              <tr><td>{{ e.date }}</td><td>{{ e.weight_kg }}</td></tr>
            {% empty %}
              <tr><td colspan="2" class="text-muted">No entries</td></tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Daily Recap Modal -->
<div class="modal fade" id="dailyRecapModal" tabindex="-1" aria-labelledby="dailyRecapModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="dailyRecapModalLabel"><i class="bi bi-calendar-day me-2"></i>Daily Recap - <span id="recapDate"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="recapLoading" class="text-center py-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
        <div id="recapContent" class="d-none">
          <!-- Summary Cards -->
          <div class="row g-3 mb-4">
            <div class="col-6 col-md-3">
              <div class="card bg-light text-center p-2">
                <div class="text-muted small">Calories In</div>
                <div class="fw-bold text-primary" id="recapCalIn">0</div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="card bg-light text-center p-2">
                <div class="text-muted small">Burned</div>
                <div class="fw-bold text-success" id="recapCalBurned">0</div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="card bg-light text-center p-2">
                <div class="text-muted small">Net</div>
                <div class="fw-bold" id="recapNetCal">0</div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="card bg-light text-center p-2">
                <div class="text-muted small">Exercise</div>
                <div class="fw-bold text-info" id="recapExMin">0 min</div>
              </div>
            </div>
          </div>
          
          <!-- Food Section -->
          <h6 class="border-bottom pb-2 mb-3"><i class="bi bi-egg-fried me-2"></i>Food</h6>
          <div id="recapFoodList" class="mb-4"></div>
          
          <!-- Exercise Section -->
          <h6 class="border-bottom pb-2 mb-3"><i class="bi bi-lightning-charge me-2"></i>Exercise</h6>
          <div id="recapExerciseList" class="mb-4"></div>
          
          <!-- Weight Section -->
          <div id="recapWeightSection">
            <h6 class="border-bottom pb-2 mb-3"><i class="bi bi-speedometer2 me-2"></i>Weight</h6>
            <div id="recapWeightList"></div>
          </div>
        </div>
        <!-- Remarks Section -->
        <h6 class="border-bottom pb-2 mb-3"><i class="bi bi-chat-quote me-2"></i>Remarks</h6>
        <div id="recapRemarksSection" class="mb-4">
          <div id="recapRemarksContent" class="d-none">
            <div class="alert alert-info p-2 mb-0" id="recapRemarksText"></div>
          </div>
          <div id="recapRemarksEmpty" class="text-muted">No remarks for this day.</div>
        </div>
         
        <div id="recapEmpty" class="d-none text-center py-4 text-muted">
          <i class="bi bi-inbox fs-1 d-block mb-2"></i>
          No entries for this day.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- ECharts -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const calDates = {{ cal_dates|safe }};
  const calValues = {{ cal_values|safe }};
  const exDates = {{ ex_dates|safe }};
  const exValues = {{ ex_values|safe }};
  const wtDates = {{ wt_dates|safe }};
  const wtValues = {{ wt_values|safe }};
  const heatmapData = {{ heatmap_data|safe }};
  const heatmapStart = '{{ heatmap_start }}';
  const heatmapEnd = '{{ heatmap_end }}';
  const todayStr = '{{ today }}';

  const tooltipStyle = { trigger: 'axis', backgroundColor: '#fff', borderColor: '#e5e5e5', textStyle: { color: '#333' } };
  const gridStyle = { left: '3%', right: '4%', bottom: '3%', containLabel: true };

  // ---------- Activity Heatmap (6 Months: Dec, Jan, Feb, Mar, Apr, May) ----------
  const heatmapChart = echarts.init(document.getElementById('heatmapChart'));

  // Build activity count map
  const activityMap = {};
  heatmapData.forEach(function(item) { activityMap[item[0]] = item[1]; });

  // Detect mobile
  const isMobile = window.innerWidth < 576;
  
  // For mobile: show only current month. For desktop: show 6 months
  let rangeStart, rangeEnd;
  if (isMobile) {
    // Current month only
    const today = new Date(todayStr);
    rangeStart = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
    rangeEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];
  } else {
    rangeStart = heatmapStart;
    rangeEnd = heatmapEnd;
  }

  // Generate all days in the range
  const startDate = new Date(rangeStart);
  const endDate = new Date(rangeEnd);
  
  const fullRangeData = [];
  for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
    const dateStr = d.toISOString().split('T')[0];
    const count = activityMap[dateStr] || 0;
    fullRangeData.push([dateStr, count]);
  }

  // Custom color function: white for 0, green shades for activity, yellow border for today
  heatmapChart.setOption({
    tooltip: {
      trigger: 'item',
      formatter: function(p) {
        if (!p.value) return '';
        const date = p.value[0];
        const count = p.value[1];
        const isToday = date === todayStr ? ' (Today)' : '';
        return date + isToday + '<br>Activities: ' + count;
      }
    },
    visualMap: {
      show: !isMobile,
      min: 0,
      max: 5,
      calculable: false,
      orient: 'horizontal',
      right: 30,
      bottom: 5,
      itemWidth: 12,
      itemHeight: 12,
      inRange: { color: ['#f5f5f5', '#9be9a8', '#40c463', '#30a14e', '#216e39'] },
      text: ['More', 'Less'],
      textStyle: { color: '#666', fontSize: 10 }
    },
    calendar: {
      top: isMobile ? 20 : 30,
      bottom: isMobile ? 10 : 40,
      left: isMobile ? 30 : 50,
      right: isMobile ? 10 : 30,
      cellSize: isMobile ? ['auto', 20] : 'auto',
      range: [rangeStart, rangeEnd],
      itemStyle: { borderWidth: 2, borderColor: '#fff', borderRadius: 2 },
      splitLine: { show: false },
      yearLabel: { show: false },
      monthLabel: { show: !isMobile, nameMap: 'en', color: '#666', fontSize: 11 },
      dayLabel: { firstDay: 0, nameMap: ['S','M','T','W','T','F','S'], color: '#999', fontSize: isMobile ? 9 : 10 }
    },
    series: [
      {
        type: 'heatmap',
        coordinateSystem: 'calendar',
        data: fullRangeData
      },
      // Today highlight (yellow border)
      {
        type: 'scatter',
        coordinateSystem: 'calendar',
        symbolSize: isMobile ? 16 : 12,
        symbol: 'roundRect',
        data: [[todayStr, activityMap[todayStr] || 0]],
        itemStyle: {
          color: 'transparent',
          borderColor: '#fbbf24',
          borderWidth: 2
        },
        zlevel: 1
      }
    ]
  });

  // Heatmap click handler - show daily recap
  heatmapChart.on('click', function(params) {
    if (params.value && params.value[0]) {
      showDailyRecap(params.value[0]);
    }
  });

  // Calories line chart
  const calChart = echarts.init(document.getElementById('calChart'));
  if (calValues.length === 0 || calValues.every(v => v === 0)) {
    document.getElementById('calChartEmpty').classList.remove('d-none');
  } else {
    calChart.setOption({
      tooltip: tooltipStyle,
      grid: gridStyle,
      xAxis: { type: 'category', data: calDates, axisLine: { lineStyle: { color: '#ddd' } }, axisLabel: { color: '#666' } },
      yAxis: { type: 'value', splitLine: { lineStyle: { color: '#f0f0f0' } }, axisLabel: { color: '#666' } },
      series: [{ data: calValues, type: 'line', smooth: true, lineStyle: { width: 3, color: '#6366f1' }, areaStyle: { color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{ offset: 0, color: 'rgba(99,102,241,0.35)' }, { offset: 1, color: 'rgba(99,102,241,0.05)' }]) }, symbol: 'circle', symbolSize: 8, itemStyle: { color: '#6366f1' } }]
    });
  }

  // Exercise bar chart
  const exChart = echarts.init(document.getElementById('exChart'));
  if (exValues.length === 0 || exValues.every(v => v === 0)) {
    document.getElementById('exChartEmpty').classList.remove('d-none');
  } else {
    exChart.setOption({
      tooltip: tooltipStyle,
      grid: gridStyle,
      xAxis: { type: 'category', data: exDates, axisLine: { lineStyle: { color: '#ddd' } }, axisLabel: { color: '#666' } },
      yAxis: { type: 'value', splitLine: { lineStyle: { color: '#f0f0f0' } }, axisLabel: { color: '#666' } },
      series: [{ data: exValues, type: 'bar', barWidth: '50%', itemStyle: { color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{ offset: 0, color: '#34d399' }, { offset: 1, color: '#10b981' }]), borderRadius: [6, 6, 0, 0] } }]
    });
  }

  // Weight line chart
  const wtChart = echarts.init(document.getElementById('wtChart'));
  if (wtValues.length === 0) {
    document.getElementById('wtChartEmpty').classList.remove('d-none');
  } else {
    wtChart.setOption({
      tooltip: tooltipStyle,
      grid: gridStyle,
      xAxis: { type: 'category', data: wtDates, axisLine: { lineStyle: { color: '#ddd' } }, axisLabel: { color: '#666' } },
      yAxis: { type: 'value', splitLine: { lineStyle: { color: '#f0f0f0' } }, axisLabel: { color: '#666' }, scale: true },
      series: [{ data: wtValues, type: 'line', smooth: true, lineStyle: { width: 3, color: '#f59e0b' }, areaStyle: { color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{ offset: 0, color: 'rgba(245,158,11,0.35)' }, { offset: 1, color: 'rgba(245,158,11,0.05)' }]) }, symbol: 'circle', symbolSize: 8, itemStyle: { color: '#f59e0b' } }]
    });
  }

  window.addEventListener('resize', function() { heatmapChart.resize(); calChart.resize(); exChart.resize(); wtChart.resize(); });

  // ---------- Daily Recap Modal ----------
  function showDailyRecap(dateStr) {
    const modal = new bootstrap.Modal(document.getElementById('dailyRecapModal'));
    const recapDate = document.getElementById('recapDate');
    const recapLoading = document.getElementById('recapLoading');
    const recapContent = document.getElementById('recapContent');
    const recapEmpty = document.getElementById('recapEmpty');
    
    // Format date nicely
    const dateObj = new Date(dateStr);
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    recapDate.textContent = dateObj.toLocaleDateString('en-US', options);
    
    // Show loading, hide content
    recapLoading.classList.remove('d-none');
    recapContent.classList.add('d-none');
    recapEmpty.classList.add('d-none');
    
    modal.show();
    
    // Fetch daily data
    fetch('/tracker/daily-recap/' + dateStr + '/')
      .then(response => response.json())
      .then(data => {
        recapLoading.classList.add('d-none');
        
        if (!data.success) {
          recapEmpty.textContent = 'Error: ' + data.error;
          recapEmpty.classList.remove('d-none');
          return;
        }
        
        const hasData = data.dietary.length > 0 || data.exercise.length > 0 || data.weight.length > 0;
        
        if (!hasData) {
          recapEmpty.classList.remove('d-none');
          return;
        }
        
        // Populate summary
        document.getElementById('recapCalIn').textContent = data.summary.total_calories_in + ' kcal';
        document.getElementById('recapCalBurned').textContent = data.summary.total_calories_burned + ' kcal';
        document.getElementById('recapExMin').textContent = data.summary.total_exercise_min + ' min';
        
        const netCal = document.getElementById('recapNetCal');
        netCal.textContent = data.summary.net_calories + ' kcal';
        netCal.className = 'fw-bold ' + (data.summary.net_calories > 2000 ? 'text-danger' : 'text-success');
        
        // Populate food list
        const foodList = document.getElementById('recapFoodList');
        if (data.dietary.length > 0) {
          foodList.innerHTML = data.dietary.map(item => `
            <div class="d-flex justify-content-between align-items-start mb-2 p-2 bg-light rounded">
              <div>
                <strong>${item.item || 'Food item'}</strong>
                ${item.notes ? '<br><small class="text-muted">' + item.notes + '</small>' : ''}
                {% comment %} ${item.remarks ? '<br><small class="text-info"><i class="bi bi-chat-quote me-1"></i>' + item.remarks + '</small>' : ''} {% endcomment %}
              </div>
              <span class="badge bg-primary">${item.calories || 0} kcal</span>
            </div>
          `).join('');
        } else {
          foodList.innerHTML = '<p class="text-muted">No food entries</p>';
        }
        
        // Populate exercise list
        const exerciseList = document.getElementById('recapExerciseList');
        if (data.exercise.length > 0) {
          exerciseList.innerHTML = data.exercise.map(item => `
            <div class="d-flex justify-content-between align-items-start mb-2 p-2 bg-light rounded">
              <div>
                <strong>${item.activity || 'Exercise'}</strong>
                <br><small class="text-muted">${item.duration_minutes || 0} minutes</small>
                 {% comment %} ${item.remarks ? '<br><small class="text-info"><i class="bi bi-chat-quote me-1"></i>' + item.remarks + '</small>' : ''} {% endcomment %}
              </div>
              <span class="badge bg-success">-${item.calories_burned || 0} kcal</span>
            </div>
          `).join('');
        } else {
          exerciseList.innerHTML = '<p class="text-muted">No exercise entries</p>';
        }
        
        // Populate weight list
        const weightSection = document.getElementById('recapWeightSection');
        const weightList = document.getElementById('recapWeightList');
        if (data.weight.length > 0) {
          weightSection.classList.remove('d-none');
          weightList.innerHTML = data.weight.map(item => `
            <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
              <span><i class="bi bi-speedometer2 me-2"></i>${item.weight_kg} kg</span>
              ${item.notes ? '<small class="text-muted">' + item.notes + '</small>' : ''}
            </div>
          `).join('');
        } else {
          weightSection.classList.add('d-none');
        }
        
        // Remarks Section
        const remarksSection = document.getElementById('recapRemarksSection');
        const remarksContent = document.getElementById('recapRemarksContent');
        const remarksText = document.getElementById('recapRemarksText');
        const remarksEmpty = document.getElementById('recapRemarksEmpty');
        let remarks = (data.remarks && data.remarks.trim() !== "") ? data.remarks : "";
        if (!remarks) {
          if (data.dietary && data.dietary.length > 0 && data.dietary[0].remarks) {
            remarks = data.dietary[0].remarks;
          } else if (data.exercise && data.exercise.length > 0 && data.exercise[0].remarks) {
            remarks = data.exercise[0].remarks;
          }
        }
        if (remarks && remarks.trim() !== "") {
          remarksText.textContent = remarks;
          remarksContent.classList.remove('d-none');
          remarksEmpty.classList.add('d-none');
        } else {
          remarksContent.classList.add('d-none');
          remarksEmpty.classList.remove('d-none');
        }
        recapContent.classList.remove('d-none');
      })
      .catch(err => {
        recapLoading.classList.add('d-none');
        recapEmpty.innerHTML = '<i class="bi bi-exclamation-triangle fs-1 d-block mb-2"></i>Failed to load data.';
        recapEmpty.classList.remove('d-none');
      });
  }
});
</script>
{% endblock %}

{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="setup-wrapper">
  <div class="setup-card">
    <!-- Progress indicator -->
    <div class="progress-steps">
      <div class="progress-step active" data-step="1">
        <div class="step-circle">1</div>
        <span class="step-label">Goal</span>
      </div>
      <div class="progress-line"></div>
      <div class="progress-step" data-step="2">
        <div class="step-circle">2</div>
        <span class="step-label">About You</span>
      </div>
      <div class="progress-line"></div>
      <div class="progress-step" data-step="3">
        <div class="step-circle">3</div>
        <span class="step-label">Body</span>
      </div>
      <div class="progress-line"></div>
      <div class="progress-step" data-step="4">
        <div class="step-circle">4</div>
        <span class="step-label">Activity</span>
      </div>
      <div class="progress-line"></div>
      <div class="progress-step" data-step="5">
        <div class="step-circle"><i class="bi bi-check"></i></div>
        <span class="step-label">Done</span>
      </div>
    </div>

    <form id="calorieSetupForm" method="post">
      {% csrf_token %}

      <!-- Step 1: Goal -->
      <div class="setup-step active" data-step="1">
        <div class="step-header">
          <div class="step-icon">
            <i class="bi bi-bullseye"></i>
          </div>
          <h3>What's your goal?</h3>
          <p class="text-muted">This helps us calculate your ideal daily calories</p>
        </div>

        <div class="goal-options">
          <label class="goal-option">
            <input type="radio" name="fitness_goal" value="lose" {% if profile.fitness_goal == 'lose' %}checked{% endif %}>
            <div class="goal-card">
              <div class="goal-icon lose"><i class="bi bi-arrow-down-circle"></i></div>
              <div class="goal-text">
                <strong>Lose Weight</strong>
                <small>Burn fat and get leaner</small>
              </div>
            </div>
          </label>
          <label class="goal-option">
            <input type="radio" name="fitness_goal" value="maintain" {% if profile.fitness_goal == 'maintain' %}checked{% endif %}>
            <div class="goal-card">
              <div class="goal-icon maintain"><i class="bi bi-arrow-left-right"></i></div>
              <div class="goal-text">
                <strong>Maintain Weight</strong>
                <small>Stay at your current weight</small>
              </div>
            </div>
          </label>
          <label class="goal-option">
            <input type="radio" name="fitness_goal" value="gain" {% if profile.fitness_goal == 'gain' %}checked{% endif %}>
            <div class="goal-card">
              <div class="goal-icon gain"><i class="bi bi-arrow-up-circle"></i></div>
              <div class="goal-text">
                <strong>Gain Weight</strong>
                <small>Build muscle and bulk up</small>
              </div>
            </div>
          </label>
        </div>
        <div class="invalid-feedback" id="error_fitness_goal"></div>
      </div>

      <!-- Step 2: Basic Info -->
      <div class="setup-step" data-step="2">
        <div class="step-header">
          <div class="step-icon">
            <i class="bi bi-person"></i>
          </div>
          <h3>Tell us about yourself</h3>
          <p class="text-muted">This helps us personalize your calorie calculation</p>
        </div>

        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Age</label>
            <input type="number" name="age" class="form-control form-control-lg"
                   placeholder="Enter your age" min="10" max="120"
                   value="{{ profile.age|default:'' }}">
            <div class="invalid-feedback" id="error_age"></div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Gender</label>
            <div class="gender-options">
              <label class="gender-option">
                <input type="radio" name="gender" value="male" {% if profile.gender == 'male' %}checked{% endif %}>
                <div class="gender-card">
                  <i class="bi bi-gender-male"></i>
                  <span>Male</span>
                </div>
              </label>
              <label class="gender-option">
                <input type="radio" name="gender" value="female" {% if profile.gender == 'female' %}checked{% endif %}>
                <div class="gender-card">
                  <i class="bi bi-gender-female"></i>
                  <span>Female</span>
                </div>
              </label>
            </div>
            <div class="invalid-feedback" id="error_gender"></div>
          </div>
        </div>
      </div>

      <!-- Step 3: Body Measurements -->
      <div class="setup-step" data-step="3">
        <div class="step-header">
          <div class="step-icon">
            <i class="bi bi-rulers"></i>
          </div>
          <h3>Body measurements</h3>
          <p class="text-muted">We use this to calculate your metabolic rate</p>
        </div>

        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Height (cm)</label>
            <div class="input-group input-group-lg">
              <input type="number" name="height_cm" class="form-control"
                     placeholder="e.g. 170" min="50" max="300" step="0.1"
                     value="{{ profile.height_cm|default:'' }}">
              <span class="input-group-text">cm</span>
            </div>
            <div class="invalid-feedback" id="error_height_cm"></div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Current Weight (kg)</label>
            <div class="input-group input-group-lg">
              <input type="number" name="initial_weight" class="form-control"
                     placeholder="e.g. 70" min="20" max="500" step="0.1"
                     value="{{ latest_weight|default:'' }}"
                     {% if latest_weight %}readonly{% endif %}>
              <span class="input-group-text">kg</span>
            </div>
            {% if latest_weight %}
            <small class="text-muted">Using your latest recorded weight</small>
            {% endif %}
            <div class="invalid-feedback" id="error_initial_weight"></div>
          </div>
        </div>
      </div>

      <!-- Step 4: Activity Level -->
      <div class="setup-step" data-step="4">
        <div class="step-header">
          <div class="step-icon">
            <i class="bi bi-lightning-charge"></i>
          </div>
          <h3>How active are you?</h3>
          <p class="text-muted">This affects how many calories you burn daily</p>
        </div>

        <div class="activity-options">
          {% for value, label in activity_choices %}
          <label class="activity-option">
            <input type="radio" name="activity_level" value="{{ value }}"
                   {% if profile.activity_level == value %}checked{% endif %}>
            <div class="activity-card">
              <div class="activity-icon">
                {% if value == 'sedentary' %}<i class="bi bi-laptop"></i>
                {% elif value == 'light' %}<i class="bi bi-person-walking"></i>
                {% elif value == 'moderate' %}<i class="bi bi-bicycle"></i>
                {% elif value == 'active' %}<i class="bi bi-trophy"></i>
                {% else %}<i class="bi bi-fire"></i>{% endif %}
              </div>
              <div class="activity-text">
                <strong>{{ label }}</strong>
              </div>
            </div>
          </label>
          {% endfor %}
        </div>
        <div class="invalid-feedback" id="error_activity_level"></div>
      </div>

      <!-- Step 5: Summary -->
      <div class="setup-step" data-step="5">
        <div class="step-header">
          <div class="step-icon success">
            <i class="bi bi-check-circle"></i>
          </div>
          <h3>Your personalized goal</h3>
          <p class="text-muted">Based on your profile, here's your daily target</p>
        </div>

        <div class="summary-card">
          <div class="calorie-goal-display">
            <span class="goal-number" id="calculatedGoal">--</span>
            <span class="goal-unit">kcal/day</span>
          </div>
          <div class="goal-description" id="goalDescription">
            <!-- Filled by JS -->
          </div>
        </div>

        <div class="summary-details">
          <div class="summary-item">
            <span class="summary-label">Goal</span>
            <span class="summary-value" id="summaryGoal">--</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Age</span>
            <span class="summary-value" id="summaryAge">--</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Gender</span>
            <span class="summary-value" id="summaryGender">--</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Height</span>
            <span class="summary-value" id="summaryHeight">--</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Weight</span>
            <span class="summary-value" id="summaryWeight">--</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Activity</span>
            <span class="summary-value" id="summaryActivity">--</span>
          </div>
        </div>
      </div>

      <!-- Navigation buttons -->
      <div class="setup-nav">
        <button type="button" class="btn btn-outline-secondary" id="prevBtn" style="visibility: hidden;">
          <i class="bi bi-arrow-left me-1"></i> Back
        </button>
        <button type="button" class="btn btn-primary" id="nextBtn">
          Next <i class="bi bi-arrow-right ms-1"></i>
        </button>
        <button type="submit" class="btn btn-success" id="submitBtn" style="display: none;">
          <i class="bi bi-check-circle me-1"></i> Start Tracking
        </button>
      </div>

      <!-- Error display -->
      <div class="alert alert-danger mt-3" id="formError" style="display: none;"></div>
    </form>
  </div>
</div>

<style>
.setup-wrapper {
  display: flex;
  justify-content: center;
  padding: 2rem 1rem;
  min-height: calc(100vh - 120px);
}

.setup-card {
  width: 100%;
  max-width: 600px;
  background: var(--card-bg, #fff);
  border-radius: 1.25rem;
  padding: 2rem;
  box-shadow: 0 4px 24px rgba(99, 102, 241, 0.08);
}

/* Progress Steps */
.progress-steps {
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 2rem;
  padding: 0 1rem;
}

.progress-step {
  display: flex;
  flex-direction: column;
  align-items: center;
  position: relative;
}

.step-circle {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: #e9ecef;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 0.9rem;
  color: #6c757d;
  transition: all 0.3s ease;
}

.progress-step.active .step-circle,
.progress-step.completed .step-circle {
  background: linear-gradient(135deg, #6366f1, #818cf8);
  color: #fff;
}

.step-label {
  font-size: 0.7rem;
  color: #6c757d;
  margin-top: 0.25rem;
  white-space: nowrap;
}

.progress-step.active .step-label {
  color: #6366f1;
  font-weight: 500;
}

.progress-line {
  flex: 1;
  height: 2px;
  background: #e9ecef;
  margin: 0 0.5rem;
  margin-bottom: 1rem;
}

/* Step Content */
.setup-step {
  display: none;
}

.setup-step.active {
  display: block;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.step-header {
  text-align: center;
  margin-bottom: 2rem;
}

.step-icon {
  width: 64px;
  height: 64px;
  border-radius: 1rem;
  background: linear-gradient(135deg, #6366f1, #818cf8);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.75rem;
  color: #fff;
  margin: 0 auto 1rem;
}

.step-icon.success {
  background: linear-gradient(135deg, #10b981, #34d399);
}

.step-header h3 {
  font-weight: 700;
  font-size: 1.35rem;
  color: var(--text, #1f2937);
  margin-bottom: 0.5rem;
}

/* Goal Options */
.goal-options {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.goal-option input {
  display: none;
}

.goal-card {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem 1.25rem;
  border: 2px solid #e9ecef;
  border-radius: 0.75rem;
  cursor: pointer;
  transition: all 0.2s ease;
}

.goal-option input:checked + .goal-card {
  border-color: #6366f1;
  background: rgba(99, 102, 241, 0.05);
}

.goal-card:hover {
  border-color: #818cf8;
}

.goal-icon {
  width: 48px;
  height: 48px;
  border-radius: 0.75rem;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
}

.goal-icon.lose { background: #fef2f2; color: #ef4444; }
.goal-icon.maintain { background: #f0fdf4; color: #22c55e; }
.goal-icon.gain { background: #eff6ff; color: #3b82f6; }

.goal-text strong {
  display: block;
  font-size: 1rem;
  color: var(--text, #1f2937);
}

.goal-text small {
  color: #6b7280;
}

/* Gender Options */
.gender-options {
  display: flex;
  gap: 0.75rem;
}

.gender-option {
  flex: 1;
}

.gender-option input {
  display: none;
}

.gender-card {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.5rem;
  padding: 1rem;
  border: 2px solid #e9ecef;
  border-radius: 0.75rem;
  cursor: pointer;
  transition: all 0.2s ease;
}

.gender-option input:checked + .gender-card {
  border-color: #6366f1;
  background: rgba(99, 102, 241, 0.05);
}

.gender-card i {
  font-size: 1.5rem;
  color: #6366f1;
}

/* Activity Options */
.activity-options {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.activity-option input {
  display: none;
}

.activity-card {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 0.875rem 1rem;
  border: 2px solid #e9ecef;
  border-radius: 0.75rem;
  cursor: pointer;
  transition: all 0.2s ease;
}

.activity-option input:checked + .activity-card {
  border-color: #6366f1;
  background: rgba(99, 102, 241, 0.05);
}

.activity-icon {
  width: 40px;
  height: 40px;
  border-radius: 0.5rem;
  background: #f3f4f6;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.25rem;
  color: #6366f1;
}

/* Summary */
.summary-card {
  background: linear-gradient(135deg, #6366f1, #818cf8);
  border-radius: 1rem;
  padding: 2rem;
  text-align: center;
  color: #fff;
  margin-bottom: 1.5rem;
}

.calorie-goal-display {
  margin-bottom: 0.5rem;
}

.goal-number {
  font-size: 3.5rem;
  font-weight: 700;
  line-height: 1;
}

.goal-unit {
  font-size: 1.25rem;
  opacity: 0.9;
}

.goal-description {
  opacity: 0.9;
  font-size: 0.95rem;
}

.summary-details {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 0.75rem;
}

.summary-item {
  display: flex;
  justify-content: space-between;
  padding: 0.5rem 0;
  border-bottom: 1px solid #e9ecef;
}

.summary-label {
  color: #6b7280;
}

.summary-value {
  font-weight: 600;
  color: var(--text, #1f2937);
}

/* Navigation */
.setup-nav {
  display: flex;
  justify-content: space-between;
  margin-top: 2rem;
  padding-top: 1.5rem;
  border-top: 1px solid #e9ecef;
}

.setup-nav .btn {
  min-width: 120px;
}

/* Form styling */
.form-control-lg {
  border-radius: 0.75rem;
}

.input-group-lg .input-group-text {
  border-radius: 0 0.75rem 0.75rem 0;
}

.invalid-feedback {
  display: block;
  margin-top: 0.25rem;
}

/* Mobile */
@media (max-width: 576px) {
  .setup-card {
    padding: 1.5rem;
  }

  .step-label {
    display: none;
  }

  .summary-details {
    grid-template-columns: 1fr;
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('calorieSetupForm');
  const steps = document.querySelectorAll('.setup-step');
  const progressSteps = document.querySelectorAll('.progress-step');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const submitBtn = document.getElementById('submitBtn');
  const formError = document.getElementById('formError');

  let currentStep = 1;
  const totalSteps = 5;

  // Activity multipliers for calculation
  const activityMultipliers = {
    'sedentary': 1.2,
    'light': 1.375,
    'moderate': 1.55,
    'active': 1.725,
    'extra': 1.9
  };

  const activityLabels = {
    'sedentary': 'Sedentary',
    'light': 'Lightly Active',
    'moderate': 'Moderately Active',
    'active': 'Very Active',
    'extra': 'Extra Active'
  };

  const goalLabels = {
    'lose': 'Lose Weight',
    'maintain': 'Maintain Weight',
    'gain': 'Gain Weight'
  };

  function showStep(step) {
    steps.forEach((s, i) => {
      s.classList.toggle('active', i + 1 === step);
    });

    progressSteps.forEach((ps, i) => {
      ps.classList.remove('active', 'completed');
      if (i + 1 < step) {
        ps.classList.add('completed');
      } else if (i + 1 === step) {
        ps.classList.add('active');
      }
    });

    prevBtn.style.visibility = step === 1 ? 'hidden' : 'visible';
    nextBtn.style.display = step === totalSteps ? 'none' : 'inline-flex';
    submitBtn.style.display = step === totalSteps ? 'inline-flex' : 'none';

    if (step === totalSteps) {
      updateSummary();
    }

    formError.style.display = 'none';
  }

  function validateStep(step) {
    let valid = true;
    clearErrors();

    if (step === 1) {
      const goal = form.querySelector('input[name="fitness_goal"]:checked');
      if (!goal) {
        showError('fitness_goal', 'Please select your goal');
        valid = false;
      }
    } else if (step === 2) {
      const age = form.querySelector('input[name="age"]').value;
      const gender = form.querySelector('input[name="gender"]:checked');

      if (!age || parseInt(age) < 10 || parseInt(age) > 120) {
        showError('age', 'Please enter a valid age (10-120)');
        valid = false;
      }
      if (!gender) {
        showError('gender', 'Please select your gender');
        valid = false;
      }
    } else if (step === 3) {
      const height = form.querySelector('input[name="height_cm"]').value;
      const weight = form.querySelector('input[name="initial_weight"]').value;

      if (!height || parseFloat(height) < 50 || parseFloat(height) > 300) {
        showError('height_cm', 'Please enter a valid height (50-300 cm)');
        valid = false;
      }
      if (!weight || parseFloat(weight) < 20 || parseFloat(weight) > 500) {
        showError('initial_weight', 'Please enter a valid weight (20-500 kg)');
        valid = false;
      }
    } else if (step === 4) {
      const activity = form.querySelector('input[name="activity_level"]:checked');
      if (!activity) {
        showError('activity_level', 'Please select your activity level');
        valid = false;
      }
    }

    return valid;
  }

  function showError(field, message) {
    const errorEl = document.getElementById('error_' + field);
    if (errorEl) {
      errorEl.textContent = message;
      errorEl.style.display = 'block';
    }
  }

  function clearErrors() {
    document.querySelectorAll('.invalid-feedback').forEach(el => {
      el.textContent = '';
      el.style.display = 'none';
    });
  }

  function calculateCalories() {
    const goal = form.querySelector('input[name="fitness_goal"]:checked')?.value;
    const age = parseInt(form.querySelector('input[name="age"]').value);
    const gender = form.querySelector('input[name="gender"]:checked')?.value;
    const height = parseFloat(form.querySelector('input[name="height_cm"]').value);
    const weight = parseFloat(form.querySelector('input[name="initial_weight"]').value);
    const activity = form.querySelector('input[name="activity_level"]:checked')?.value;

    if (!goal || !age || !gender || !height || !weight || !activity) {
      return null;
    }

    // Mifflin-St Jeor Equation
    let bmr = (10 * weight) + (6.25 * height) - (5 * age);
    bmr += gender === 'male' ? 5 : -161;

    // TDEE
    const tdee = bmr * activityMultipliers[activity];

    // Goal adjustment
    let dailyGoal = tdee;
    if (goal === 'lose') dailyGoal -= 500;
    else if (goal === 'gain') dailyGoal += 500;

    // Minimum calorie floor
    const minCal = gender === 'male' ? 1500 : 1200;
    dailyGoal = Math.max(dailyGoal, minCal);

    return Math.round(dailyGoal);
  }

  function updateSummary() {
    const goal = form.querySelector('input[name="fitness_goal"]:checked')?.value;
    const age = form.querySelector('input[name="age"]').value;
    const gender = form.querySelector('input[name="gender"]:checked')?.value;
    const height = form.querySelector('input[name="height_cm"]').value;
    const weight = form.querySelector('input[name="initial_weight"]').value;
    const activity = form.querySelector('input[name="activity_level"]:checked')?.value;

    const calories = calculateCalories();

    document.getElementById('calculatedGoal').textContent = calories || '--';
    document.getElementById('summaryGoal').textContent = goalLabels[goal] || '--';
    document.getElementById('summaryAge').textContent = age ? age + ' years' : '--';
    document.getElementById('summaryGender').textContent = gender ? (gender.charAt(0).toUpperCase() + gender.slice(1)) : '--';
    document.getElementById('summaryHeight').textContent = height ? height + ' cm' : '--';
    document.getElementById('summaryWeight').textContent = weight ? weight + ' kg' : '--';
    document.getElementById('summaryActivity').textContent = activityLabels[activity] || '--';

    // Goal description
    let description = '';
    if (goal === 'lose') {
      description = 'This deficit will help you lose about 0.5 kg per week safely.';
    } else if (goal === 'gain') {
      description = 'This surplus will help you gain about 0.5 kg per week.';
    } else {
      description = 'This maintains your current weight with your activity level.';
    }
    document.getElementById('goalDescription').textContent = description;
  }

  nextBtn.addEventListener('click', function() {
    if (validateStep(currentStep)) {
      if (currentStep < totalSteps) {
        currentStep++;
        showStep(currentStep);
      }
    }
  });

  prevBtn.addEventListener('click', function() {
    if (currentStep > 1) {
      currentStep--;
      showStep(currentStep);
    }
  });

  form.addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(form);
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Saving...';

    fetch(form.action || window.location.href, {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        window.location.href = data.redirect || '/tracker/dashboard/';
      } else {
        if (data.errors) {
          for (const [field, msg] of Object.entries(data.errors)) {
            showError(field, msg);
          }
          // Go back to step with error
          if (data.errors.fitness_goal) currentStep = 1;
          else if (data.errors.age || data.errors.gender) currentStep = 2;
          else if (data.errors.height_cm || data.errors.initial_weight) currentStep = 3;
          else if (data.errors.activity_level) currentStep = 4;
          showStep(currentStep);
        } else {
          formError.textContent = data.error || 'An error occurred';
          formError.style.display = 'block';
        }
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i> Start Tracking';
      }
    })
    .catch(error => {
      formError.textContent = 'Network error. Please try again.';
      formError.style.display = 'block';
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i> Start Tracking';
    });
  });

  // Initialize
  showStep(currentStep);
});
</script>
{% endblock %}
